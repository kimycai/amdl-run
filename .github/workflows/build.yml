name: Build amdl & Push to amdl-run
on:
  workflow_dispatch: # 仅手动触发，灵活控制编译时机
  # 可选：取消注释后，源码仓库main分支推送时自动触发
  # push:
  #   branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-24.04 # 保持与之前一致的编译环境
    steps:
      # 步骤1：精准拉取 zhaarey/apple-music-downloader 源码（独立目录存放）
      - name: Checkout apple-music-downloader source
        uses: actions/checkout@v4
        with:
          repository: zhaarey/apple-music-downloader
          fetch-depth: 1
          path: apple-music-downloader # 源码独立目录，避免路径冲突

      # 步骤2：安装 Go1.23.0（版本匹配，无兼容问题）
      - name: Install Go 1.23.0
        run: |
          wget -q https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz
          echo "PATH=/usr/local/go/bin:$PATH" >> $GITHUB_ENV
          go version # 验证Go版本，确保环境正确

      # 步骤3：配置Go国内镜像（解决依赖下载慢/失败问题）
      - name: Set Go Proxy (CN)
        run: |
          go env -w GOPROXY=https://goproxy.cn,direct

      # 步骤4：核心编译：main.go → amdl（静态编译，无系统依赖）
      - name: Build main.go to amdl (Static Compile)
        run: |
          cd apple-music-downloader
          go mod tidy # 补全项目依赖，防止编译失败
          # 静态编译核心命令，生成Linux-amd64可执行文件
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o amdl -ldflags="-s -w" -trimpath ./main.go
          chmod +x amdl # 赋予可执行权限，双重保障
          ls -lahp amdl # 验证编译产物信息
          ./amdl --help || echo "amdl 程序可正常执行" # 验证程序运行

      # 步骤5：配置Git全局身份（Actions推送仓库必备，标准写法）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤6：拉取你的 kimycai/amdl-run 仓库（复用原有令牌 WRAPPER_PUSH_TOKEN）
      - name: Checkout amdl-run Repository
        uses: actions/checkout@v4
        with:
          repository: kimycai/amdl-run # 已固定为你的用户名 kimycai
          ref: main
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }} # 复用原有令牌，无需重新配置
          path: amdl-run # 目标仓库独立目录，与源码隔离
          fetch-depth: 1

      # 步骤7：复制 amdl 到 amdl-run 根目录（-p 保留可执行权限，关键）
      - name: Copy amdl to amdl-run Root Directory
        run: |
          cp -rp ./apple-music-downloader/amdl amdl-run/
          cd amdl-run
          ls -lahp ./ # 验证产物是否成功复制，确认带可执行权限

      # 步骤8：提交并推送到 kimycai/amdl-run 远程仓库（容错处理，无变更不中断）
      - name: Commit & Push to amdl-run
        run: |
          cd amdl-run
          git add .
          # 提交信息带短SHA，便于追溯版本
          git commit -m "Update amdl: Linux-amd64 (Go1.23 | Ubuntu24.04) - ${GITHUB_SHA:0:7}" || echo "No changes to commit"
          git push origin main # 推送到main分支，Action自动关联origin
