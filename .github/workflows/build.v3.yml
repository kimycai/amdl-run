name: Comment Scan Build amdl & Push All Files to amdl-run
on:
  workflow_dispatch: # 仅手动触发，灵活控制执行时机
  # 可选：取消注释后，源码仓库main分支推送时自动触发
  # push:
  #   branches: [ "main" ]

jobs:
  build-and-push-all:
    runs-on: ubuntu-24.04 # 保持与之前一致的编译环境
    steps:
      # 步骤1：精准拉取 zhaarey/apple-music-downloader 完整源码（独立目录）
      - name: Checkout apple-music-downloader source
        uses: actions/checkout@v4
        with:
          repository: zhaarey/apple-music-downloader
          fetch-depth: 1 # 浅克隆提升速度，保留所有项目文件
          path: apple-music-downloader # 源码独立目录，避免路径冲突

      # 步骤2：安装 Go1.23.0（版本匹配，无兼容问题）
      - name: Install Go 1.23.0
        run: |
          wget -q https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz
          echo "PATH=/usr/local/go/bin:$PATH" >> $GITHUB_ENV
          go version # 验证Go版本，确保环境正确

      # 步骤3：配置Go国内镜像（解决依赖下载慢/失败问题）
      - name: Set Go Proxy (CN)
        run: |
          go env -w GOPROXY=https://goproxy.cn,direct

      # 【修复后步骤4】注释main.go中的所有fmt.Scanln()，使用//单行注释（ubuntu兼容）
      - name: Comment out all fmt.Scanln() in main.go with //
        run: |
          cd apple-music-downloader
          # 正确的sed原地替换命令：仅注释含fmt.Scanln()的行，ubuntu-24.04原生兼容
          sed -i '/fmt.Scanln()/s/^/\/\//' main.go

      # 步骤5：核心编译：main.go → amdl（静态编译，生成在源码根目录）
      - name: Build main.go to amdl (Static Compile)
        run: |
          cd apple-music-downloader
          go mod tidy # 补全项目依赖，防止编译失败
          # 静态编译核心命令，amdl直接生成在源码根目录（与其他项目文件同目录）
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o amdl -ldflags="-s -w" -trimpath ./main.go
          chmod +x amdl # 双重赋予可执行权限，避免权限丢失
          ls -lahp amdl # 验证编译产物信息
          ./amdl --help || echo "amdl 程序可正常执行" # 验证程序运行状态

      # 步骤6：配置Git全局身份（Actions推送仓库必备，标准写法）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤7：拉取你的 kimycai/amdl-run 仓库（复用原有令牌 WRAPPER_PUSH_TOKEN）
      - name: Checkout amdl-run Repository
        uses: actions/checkout@v4
        with:
          repository: kimycai/amdl-run # 已固定为你的用户名 kimycai
          ref: main # 推送到main分支
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }} # 复用原有令牌，无需重新配置
          path: amdl-run # 目标仓库独立目录，与源码隔离
          fetch-depth: 1 # 浅克隆，Action自动兼容

      # 步骤8：核心修改：复制**源码目录所有文件**到 amdl-run 根目录（保留权限+结构）
      - name: Copy All Project Files to amdl-run Root
        run: |
          # 递归复制源码目录下所有文件/文件夹到amdl-run根目录
          # -r：递归复制目录，-p：保留文件权限（可执行/读写）、时间戳
          cp -rp ./apple-music-downloader/* amdl-run/
          # 进入目标仓库，验证复制结果：确认amdl和所有项目文件存在
          cd amdl-run
          ls -lahp ./ # 查看根目录文件，确认结构与原项目一致

      # 步骤9：提交并推送到 kimycai/amdl-run 远程仓库（容错处理，无变更不中断）
      - name: Commit & Push All Files to amdl-run
        run: |
          cd amdl-run
          git add . # 暂存所有变更（amdl+所有项目文件+注释后的main.go）
          # 提交信息带短SHA，便于追溯编译版本
          git commit -m "Update all files + amdl: Linux-amd64 (Go1.23 | Ubuntu24.04) - ${GITHUB_SHA:0:7}" || echo "No changes to commit"
          git push origin main # 推送到远程main分支，Action自动关联origin
