name: Build amdl for Windows & Push All Files to amdl-run
on:
  workflow_dispatch: # 仅手动触发，灵活控制执行时机
  # 可选：取消注释后，源码仓库main分支推送时自动触发
  # push:
  #   branches: [ "main" ]

jobs:
  build-and-push-all:
    runs-on: windows-latest # Windows环境编译
    steps:
      # 步骤1：精准拉取 zhaarey/apple-music-downloader 完整源码（独立目录）
      - name: Checkout apple-music-downloader source
        uses: actions/checkout@v4
        with:
          repository: zhaarey/apple-music-downloader
          fetch-depth: 1 # 浅克隆提升速度，保留所有项目文件
          path: apple-music-downloader # 源码独立目录，避免路径冲突

      # 步骤2：安装 Go（使用最新稳定版，Windows环境）
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23' # 使用Go 1.23版本
          
      # 注释main.go中所有fmt.Scanln()，兼容Windows环境
      - name: Comment out all fmt.Scanln() in main.go
        run: |
          cd apple-music-downloader
          $content = Get-Content main.go -Raw
          $modified = $content -replace '(fmt\.Scanln\(\))', '// $1'
          $modified | Out-File -FilePath main.go -Encoding UTF8
          # 验证修改结果
          Select-String -Path main.go -Pattern "fmt.Scanln" -AllMatches

      # 步骤3：核心编译：main.go → amdl.exe（Windows可执行文件，指定名称）
      - name: Build main.go to amdl.exe (Windows)
        run: |
          cd apple-music-downloader
          # 使用官方推荐的简单编译命令，输出为amdl.exe
          go build -o amdl.exe -v ./main.go
          Get-ChildItem amdl.exe # 验证编译产物信息
          ./amdl.exe --help || echo "amdl.exe compiled successfully" # 验证程序，即使返回非零退出码也不停止

      # 步骤4：配置Git全局身份（Actions推送仓库必备，标准写法）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤5：拉取你的 kimycai/amdl-run 仓库（复用原有令牌 WRAPPER_PUSH_TOKEN）
      - name: Checkout amdl-run Repository
        uses: actions/checkout@v4
        with:
          repository: kimycai/amdl-run # 已固定为你的用户名 kimycai
          ref: main # 推送到main分支
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }} # 复用原有令牌，无需重新配置
          path: amdl-run # 目标仓库独立目录，与源码隔离
          fetch-depth: 1 # 浅克隆，Action自动兼容

      # 步骤6：复制编译产物和项目文件到目标目录
      - name: Copy Compiled Files and Project Files to amdl-run
        run: |
          # 复制amdl.exe到目标目录
          Copy-Item -Path "apple-music-downloader/amdl.exe" -Destination "amdl-run/" -Force
          
          # 复制源码目录的其他重要文件（除了main.go，保留原始项目结构）
          Get-ChildItem -Path "apple-music-downloader/" -Exclude "main.go", "amdl.exe", "*.md" | ForEach-Object {
            if (Test-Path "amdl-run/$($_.Name)") {
              Remove-Item -Recurse -Force "amdl-run/$($_.Name)"
            }
            Copy-Item $_.FullName -Destination "amdl-run/" -Recurse
          }

      # 步骤7：创建ZIP压缩包作为构建产物
      - name: Create ZIP Archive
        run: |
          cd amdl-run
          # 创建包含所有文件的ZIP压缩包
          Compress-Archive -Path * -DestinationPath "../amdl-windows-build.zip" -Force
          
      # 步骤8：上传ZIP作为构建产物
      - name: Upload ZIP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: amdl-windows-build
          path: amdl-windows-build.zip

      # 步骤9：提交并推送到 kimycai/amdl-run 远程仓库（容错处理，无变更不中断）
      - name: Commit & Push All Files to amdl-run
        run: |
          cd amdl-run
          git add . # 暂存所有变更（amdl.exe+所有项目文件+注释后的main.go）
          # 提交信息带短SHA，便于追溯编译版本
          git commit -m "Update amdl.exe + all files: Windows-amd64 (Go1.23 | Windows-latest) - ${GITHUB_SHA:0:7}" || echo "No changes to commit"
          git push origin main # 推送到远程main分支，Action自动关联origin
